

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>视图 &mdash; CITA 0.8 文档</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="CITA 0.8 文档" href="index.html"/>
        <link rel="next" title="常见问题" href="faq.html"/>
        <link rel="prev" title="交易处理" href="transaction_process.html"/> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="index.html" class="icon icon-home"> CITA
          

          
          </a>

          
            
            
              <div class="version">
                0.8
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <p class="caption"><span class="caption-text">快速入门</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="getting_started.html">依赖</a></li>
<li class="toctree-l1"><a class="reference internal" href="getting_started.html#id4">安装</a></li>
<li class="toctree-l1"><a class="reference internal" href="getting_started.html#id5">配置</a></li>
<li class="toctree-l1"><a class="reference internal" href="getting_started.html#id6">运行</a></li>
<li class="toctree-l1"><a class="reference internal" href="getting_started.html#id7">验证</a></li>
</ul>
<p class="caption"><span class="caption-text">主要概念</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="blockchain.html">区块链</a></li>
<li class="toctree-l1"><a class="reference internal" href="features.html">CITA</a></li>
</ul>
<p class="caption"><span class="caption-text">系统组件</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="rpc_model.html">服务网关</a></li>
<li class="toctree-l1"><a class="reference internal" href="consensus_model.html">共识</a></li>
<li class="toctree-l1"><a class="reference internal" href="chain_model.html">链（Chain）</a></li>
<li class="toctree-l1"><a class="reference internal" href="contract_model.html">合约引擎（Contract Engine）</a></li>
</ul>
<p class="caption"><span class="caption-text">使用指南</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="rpc.html">RPC 调用</a></li>
<li class="toctree-l1"><a class="reference internal" href="smart_contract.html">智能合约指南</a></li>
</ul>
<p class="caption"><span class="caption-text">系统管理</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="nodes_lists.html">节点白名单管理</a></li>
<li class="toctree-l1"><a class="reference internal" href="consensus_nodes_manager.html">共识节点管理</a></li>
<li class="toctree-l1"><a class="reference internal" href="account_manager.html">账号管理</a></li>
<li class="toctree-l1"><a class="reference internal" href="quota_manager.html">配额管理</a></li>
</ul>
<p class="caption"><span class="caption-text">架构设计</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="architecture.html">系统架构</a></li>
<li class="toctree-l1"><a class="reference internal" href="consensus.html">共识</a></li>
<li class="toctree-l1"><a class="reference internal" href="transaction_process.html">交易处理</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="">视图</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#id2">账号</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id3">存储</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#merkle-tree">Merkle Tree</a></li>
<li class="toctree-l3"><a class="reference internal" href="#merkle-patricia-trie">Merkle Patricia Trie</a></li>
<li class="toctree-l3"><a class="reference internal" href="#merkle-avl-tree">Merkle AVL Tree</a></li>
<li class="toctree-l3"><a class="reference internal" href="#simple-merkle-tree">Simple Merkle Tree</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">附录</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="faq.html">常见问题</a></li>
<li class="toctree-l1"><a class="reference internal" href="glossary.html">词汇表</a></li>
<li class="toctree-l1"><a class="reference internal" href="releases.html">版本发布说明</a></li>
<li class="toctree-l1"><a class="reference internal" href="contributing.html">贡献代码</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="index.html">CITA</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          





<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="index.html">Docs</a> &raquo;</li>
      
    <li>视图</li>
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="_sources/view.txt" rel="nofollow"> View page source</a>
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="id1">
<h1>视图<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h1>
<div class="section" id="id2">
<h2>账号<a class="headerlink" href="#id2" title="永久链接至标题">¶</a></h2>
<p>视图状态是执行器执行过程中读写的对象，常见的视图状态模型有UTXO及账户两种。在UTXO模型中，由UTXO构成账本视图，每个交易在销毁旧有UTXO的同时创造新的UTXO；在账户模型中，由账户构成世界状态视图，交易在处理过程中可以读写多个账户。
账户模型相对更加简单，实现通用任务更有效率。在企业级应用中往往存在身份验证与授权的需要，这些服务所依赖的数据可以自然的与账户模型关联。CITA默认支持账户模型。用户可以自定义包括UTXO在内的其他状态模型。</p>
<p>在CITA中存在两种账号：外部账号和合约账号。外部账号通常情况下代表用户的身份，用户可以通过外部账号来发送交易。与公链不同，CITA具有用户准入机制。首先用户自行生成私钥和公钥，私钥由用户妥善保存；
然后将公钥通过链外的方式提交给CITA系统中的KYC系统；通过申请之后，系统管理员将用户公钥通过操作账户管理合约，发送交易将用户加入CITA网络中。对于未准入的外部账户，无法向CITA发送交易。同时，CITA内置了基于角色的权限管理，系统管理员（角色）可以根据实际情况灵活配置账户的权限。</p>
<p>为了阻止重播攻击，每笔交易必须有nonce，这就使得账户需要跟踪nonce的使用情况。CITA中用户可以根据实际业务需求，自定义nonce防重放机制。现阶段CITA兼容了Ethereum的自增nonce的防重放机制。</p>
<p>总体来讲，外部账户具有以下特性：</p>
<ul class="simple">
<li>外部账号需要准入机制；</li>
<li>通过私钥控制，可以发送交易；</li>
<li>同一账户可以支持多种签名；</li>
<li>支持用户自定义的交易放重放规则。</li>
</ul>
<p>合约账户与外部账户最大的区别在于，合约账户通过交易进行创建，合约内部维护一定的代码，合约的执行和调用通过外部账户发送交易来进行。当前CITA支持EVM虚拟机，用户可以通过直接发送合约代码的方式来创建合约，也可以通过合约调用的方式来创建合约。</p>
<p>总体来讲，合约账户具有以下特性：</p>
<ul class="simple">
<li>合约账号通过交易创建，并支持合约创建合约；</li>
<li>合约通过交易调用，并支持合约间互相调用；</li>
<li>合约具有图灵完备性，但是交易对计算资源的配额受系统合约控制；</li>
<li>合约维持自身的特定储存状态；</li>
<li>CITA内置系统合约模块，在创始块中生成，方便用户对系统进行管理。</li>
</ul>
</div>
<div class="section" id="id3">
<h2>存储<a class="headerlink" href="#id3" title="永久链接至标题">¶</a></h2>
<p>区块链本质上去中心化的分布式复制状态机，每个节点通过持久化的方式来保存自身的状态。CITA使用KV持久化数据存储，支持RocksDB、LevelDB。节点将Block结构，交易以及合约状态等持久化保存到KV数据库中。</p>
<p>为了更高效的检索和更新数据，区块链一般会在内存中维护某种数据结构的视图模型。对于传统的区块链，如Bitcoin采用了Merkle Tree来保存交易；Ethereum采用了Merkle Patricia Tree，一种改进的Merkle Tree来保存状态和交易。
CITA采用了一种更高效的AVL来保存账户状态，并且采用了Simple Merkle Tree来保存交易列表和交易回执。下面我们将分别介绍这几种模型。</p>
<div class="section" id="merkle-tree">
<h3>Merkle Tree<a class="headerlink" href="#merkle-tree" title="永久链接至标题">¶</a></h3>
<p>在Bitcoin中的每个区块都包含了产生于该区块的所有交易，且以Merkle树表示。Merkle树是一种哈希二叉树，它是一种用作快速归纳和校验大规模数据完整性的数据结构。这种二叉树包含加密哈希值。</p>
<p>在比特币网络中，Merkle树被用来归纳一个区块中的所有交易，同时生成整个交易集合的数字指纹，且提供了一种校验区块是否存在某交易的高效途径。生成一棵完整的Merkle树需要递归地对哈希节点对进行哈希，并将新生成的哈希节点插入到Merkle树中，直到只剩一个哈希节点，该节点就是Merkle树的根。</p>
<p>当N个数据元素经过加密后插入Merkle树时，你至多计算2*log2(N)次就能检查出任意某数据元素是否在该树中，这使得该数据结构非常高效。同时Merkle树可以很好的支持轻节点。</p>
<img alt="_images/merkle-tree.png" src="_images/merkle-tree.png" />
</div>
<div class="section" id="merkle-patricia-trie">
<h3>Merkle Patricia Trie<a class="headerlink" href="#merkle-patricia-trie" title="永久链接至标题">¶</a></h3>
<p>在Ethereum中，使用Trie来构建Merkle tree，即Merkle Patricia Trie。它是Ethereum中主要的数据结构，用来存储所有账号的状态以及交易和交易回执。MPT支持高效的检索及动态的插入、删除、修改，Ethereum将其命名为Merkle Patricia Tree（MPT），其示意图如下：</p>
<img alt="_images/merkle-patricia-trie.png" src="_images/merkle-patricia-trie.png" />
<p>更多关于MPT的介绍可以参考Ethereum <a class="reference external" href="https://github.com/ethereum/wiki/wiki/Patricia-Tree">Patricia-Tree</a> 。</p>
</div>
<div class="section" id="merkle-avl-tree">
<h3>Merkle AVL Tree<a class="headerlink" href="#merkle-avl-tree" title="永久链接至标题">¶</a></h3>
<p>对于Ethereum中的MPT，由于Sha3运算的开销并不低。随着账户地址的增多，以及合约存储数据量的增多，Sha3计算的数据量也会增多。对于常见金融领域来讲，千万级数据将会导致MPT性能下降，Sha3的计算将有可能成为瓶颈。
为了提高效率，我们希望在每次更新树时能够计算Sha3的数据量最少。对于树形结构，更新一个节点所需要重新计算的Sha3数据量约为O(mlog<sub>m</sub>n)，其中 m 为分支数，故当 m=2 时，Sha3的计算量最小。
又因为AVL Tree的平衡性更好（尽管这意味着更多的旋转操作，幸运的是旋转操作并不增加Sha3计算），同时又能很好地保持MPT动态插入、删除、修改的特点。因此选用AVL Tree来构建Merkle Tree似乎是一个不错的选择，我们简称之为MAT。</p>
<p>更多关于AVL的介绍可以参考Wiki <a class="reference external" href="https://en.wikipedia.org/wiki/AVL_tree">AVL_tree</a> 。</p>
</div>
<div class="section" id="simple-merkle-tree">
<h3>Simple Merkle Tree<a class="headerlink" href="#simple-merkle-tree" title="永久链接至标题">¶</a></h3>
<p>在Ethreum中，交易和交易回执同样采用MPT树来进行保存。而CITA中，区块中的交易在共识完成后就已经确认了。所以在Chain处理交易时，交易的顺序和交易结果的顺序都是确定不变的。
而MPT树优点是便于保存历史快照可维持可变性，对于静态数据可以采用Merkle树，而不必采用MPT和AVL这样的数据结构。而比特币的Merkle树在处理奇数节点时，需要拷贝节点，额外做一次Sha3计算。
CITA采用了简单的Merkle树来保存，对于奇数个节点情况，计算Sha3的次数会减少。</p>
<div class="highlight-python"><div class="highlight"><pre>              <span class="o">*</span>
             <span class="o">/</span> \
           <span class="o">/</span>     \
         <span class="o">/</span>         \
        <span class="o">/</span>            \
      <span class="o">*</span>               <span class="o">*</span>
     <span class="o">/</span> \             <span class="o">/</span> \
    <span class="o">/</span>   \           <span class="o">/</span>   \
   <span class="o">/</span>     \         <span class="o">/</span>     \
  <span class="o">*</span>       <span class="o">*</span>       <span class="o">*</span>       <span class="n">h6</span>
 <span class="o">/</span> \     <span class="o">/</span> \     <span class="o">/</span> \
<span class="n">h0</span>  <span class="n">h1</span>  <span class="n">h2</span>  <span class="n">h3</span>  <span class="n">h4</span>  <span class="n">h5</span>
</pre></div>
</div>
</div>
</div>
</div>


           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="faq.html" class="btn btn-neutral float-right" title="常见问题" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="transaction_process.html" class="btn btn-neutral" title="交易处理" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; 版权所有 2017, Cryptape.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'0.8',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>
      <script type="text/javascript" src="_static/translations.js"></script>
      <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>